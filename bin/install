#!/usr/bin/env bash

# this is global for error reporting
ASDF_JAVA_ERROR=""

# Download the java source from java.net, copy files and cleanup.
install_java() {
	local version=$1
	local destdir=$2

	local arch=$(get_arch)
	[[ -z "$ASDF_JAVA_ERROR" ]] || return

	get_java $version $arch $destdir
	[[ -z "$ASDF_JAVA_ERROR" ]] || return

	unpack_java $destdir
	[[ -z "$ASDF_JAVA_ERROR" ]] || return
}

# Get the "arch" piece of the Oracle url.
get_arch() {
	case "$(uname -s)" in
		Linux)
			case "$(uname -m)" in
				x86_64) echo linux ;;
				*) ASDF_JAVA_ERROR="$(uname -m) is not supported on linux" ;;
			esac ;;
		Darwin)
			case "$(uname -m)" in
				x86_64) echo osx ;;
				*) ASDF_JAVA_ERROR="$(uname -m) is not supported on macos" ;;
			esac ;;
		*) ASDF_JAVA_ERROR="$(uname -s) is not supported" ;;
	esac
}

# Download java from java.net
get_java() {
	local version=$1
	local arch=$2
	local destdir=$3

	local main_version=$(echo $version | cut -d. -f1)
	local url=https://download.java.net/java/GA/jdk$main_version/$version/binaries/openjdk-${version}_$arch-x64_bin.tar.gz
	
	echo "---- ASDF JAVA MESSAGE ----"
	echo "downloading: $url"

	curl -fLC - \
		--progress-bar \
		--retry 3 --retry-delay 3 \
		-b oraclelicense=a \
		-o $destdir/openjdk.tar.gz $url

	[[ $? != 0 ]] && ASDF_JAVA_ERROR="downloading java dist"
}

# Unpacks all kinds of sources.
unpack_java() {
	local destdir=$1

	echo "---- ASDF JAVA MESSAGE ----"
	echo "expanding java dist"

# Unarchive a tar archive into the install directory and cleanup.
#
# NOTE: Using $origin as a memo rather than executing in a subshell
#   because errors won't be persisted from a subshell.
#
# TODO: Should be sanitized with error reporting.
	local origin=$(pwd)
	cd $destdir; {
		tar -xzf openjdk.tar.gz
		[[ $? == 0 ]] || ASDF_JAVA_ERROR="expanding java dist"
		rm openjdk.tar.gz

		local pkg=$(find jdk-* -name bin -exec dirname {} \;)
		mv $pkg/* .
		rm -rf jdk-*
	}; cd $origin
}

#
# MAIN
#
echo $ASDF_INSTALL_PATH
install_java $ASDF_INSTALL_VERSION $ASDF_INSTALL_PATH

if ! [[ -z "$ASDF_JAVA_ERROR" ]]; then
	rm -rf $ASDF_INSTALL_PATH

	echo "---- ASDF JAVA ERROR ----"
	echo "asdf java failed while $ASDF_JAVA_ERROR"
	echo "----"
fi
unset ASDF_JAVA_ERROR
